generator client {
  provider = "prisma-client-js"
  output   = "../app/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum Role {
  STUDENT
  ADMIN
}

enum SessionType {
  ONE_ON_ONE
  BATCH
}

enum BookingStatus {
  PENDING
  CONFIRMED
  CANCELLED
  COMPLETED
}

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
  REFUNDED
}

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  passwordHash  String
  name          String
  role          Role      @default(STUDENT)
  isBlocked     Boolean   @default(false)
  avatarUrl     String?
  phone         String?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  sessions              Session[]
  worksheetCompletions  WorksheetCompletion[]
  subjectPurchases      SubjectPurchase[]
  packagePurchases      PackagePurchase[]
  drillAttempts         DrillAttempt[]
  liveBookings          LiveBooking[]
  couponUsages          CouponUsage[]

  @@index([email])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  userAgent String?
  ip        String?
  expiresAt DateTime
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("sessions")
}

model Grade {
  id        String   @id @default(cuid())
  name      String   @unique
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subjects Subject[]

  @@map("grades")
}

model Subject {
  id        String   @id @default(cuid())
  gradeId   String
  name      String
  slug      String   @unique
  price     Int      @default(0)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  grade    Grade     @relation(fields: [gradeId], references: [id], onDelete: Cascade)
  chapters Chapter[]
  subjectPurchases SubjectPurchase[]

  @@index([gradeId])
  @@map("subjects")
}

model Chapter {
  id        String   @id @default(cuid())
  subjectId String
  name      String
  slug      String   @unique
  sortOrder Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subject    Subject     @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  worksheets Worksheet[]

  @@index([subjectId])
  @@map("chapters")
}

model Worksheet {
  id          String   @id @default(cuid())
  chapterId   String
  title       String
  slug        String   @unique
  description String?
  tier        String   @default("foundational")
  pdfUrl      String?
  answerUrl   String?
  sortOrder   Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  chapter     Chapter               @relation(fields: [chapterId], references: [id], onDelete: Cascade)
  completions WorksheetCompletion[]

  @@index([chapterId])
  @@map("worksheets")
}

model WorksheetCompletion {
  id          String   @id @default(cuid())
  userId      String
  worksheetId String
  score       Int?
  maxScore    Int?
  timeSpent   Int?
  completedAt DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  worksheet Worksheet @relation(fields: [worksheetId], references: [id], onDelete: Cascade)

  @@unique([userId, worksheetId])
  @@index([userId])
  @@index([worksheetId])
  @@map("worksheet_completions")
}

model SubjectPurchase {
  id            String        @id @default(cuid())
  userId        String
  subjectId     String
  amountPaid    Int
  paymentStatus PaymentStatus @default(PENDING)
  paymentRef    String?
  couponId      String?
  purchasedAt   DateTime      @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  subject Subject @relation(fields: [subjectId], references: [id], onDelete: Cascade)
  coupon  Coupon? @relation(fields: [couponId], references: [id])

  @@unique([userId, subjectId])
  @@index([userId])
  @@map("subject_purchases")
}

model Package {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  price       Int
  subjectIds  String[]
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchases PackagePurchase[]

  @@map("packages")
}

model PackagePurchase {
  id            String        @id @default(cuid())
  userId        String
  packageId     String
  amountPaid    Int
  paymentStatus PaymentStatus @default(PENDING)
  paymentRef    String?
  couponId      String?
  purchasedAt   DateTime      @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  package Package @relation(fields: [packageId], references: [id], onDelete: Cascade)
  coupon  Coupon? @relation(fields: [couponId], references: [id])

  @@unique([userId, packageId])
  @@index([userId])
  @@map("package_purchases")
}

model DrillPack {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  subjectTag  String?
  difficulty  String   @default("medium")
  totalXp     Int      @default(0)
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  attempts DrillAttempt[]

  @@map("drill_packs")
}

model DrillAttempt {
  id          String   @id @default(cuid())
  userId      String
  drillPackId String
  score       Int
  maxScore    Int
  xpEarned    Int      @default(0)
  timeSpent   Int?
  attemptedAt DateTime @default(now())

  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  drillPack DrillPack @relation(fields: [drillPackId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([drillPackId])
  @@map("drill_attempts")
}

model LiveSession {
  id           String      @id @default(cuid())
  title        String
  description  String?
  sessionType  SessionType @default(ONE_ON_ONE)
  maxStudents  Int         @default(1)
  pricePerSlot Int
  scheduledAt  DateTime
  durationMins Int         @default(60)
  meetingUrl   String?
  isActive     Boolean     @default(true)
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt

  bookings LiveBooking[]

  @@map("live_sessions")
}

model LiveBooking {
  id            String        @id @default(cuid())
  userId        String
  liveSessionId String
  status        BookingStatus @default(PENDING)
  amountPaid    Int
  paymentStatus PaymentStatus @default(PENDING)
  paymentRef    String?
  couponId      String?
  bookedAt      DateTime      @default(now())

  user        User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  liveSession LiveSession @relation(fields: [liveSessionId], references: [id], onDelete: Cascade)
  coupon      Coupon?     @relation(fields: [couponId], references: [id])

  @@unique([userId, liveSessionId])
  @@index([userId])
  @@index([liveSessionId])
  @@map("live_bookings")
}

model Coupon {
  id              String    @id @default(cuid())
  code            String    @unique
  discountPercent Int
  maxUses         Int?
  usedCount       Int       @default(0)
  minAmount       Int       @default(0)
  expiresAt       DateTime?
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now())

  subjectPurchases SubjectPurchase[]
  packagePurchases PackagePurchase[]
  liveBookings     LiveBooking[]
  usages           CouponUsage[]

  @@map("coupons")
}

model CouponUsage {
  id       String   @id @default(cuid())
  userId   String
  couponId String
  usedAt   DateTime @default(now())

  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@unique([userId, couponId])
  @@index([userId])
  @@map("coupon_usages")
}
